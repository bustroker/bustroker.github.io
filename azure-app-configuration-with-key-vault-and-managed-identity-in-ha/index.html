<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Software development"><title>Azure App Configuration with Key Vault and Managed Identity in HA | Bustroker's cheat sheet</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/2.0.4/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/2.1.4/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/2.1.4/toastr.min.css"><meta name="generator" content="Hexo 4.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Azure App Configuration with Key Vault and Managed Identity in HA</h1><a id="logo" href="/.">Bustroker's cheat sheet</a><p class="description">Quick notes on coding.</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Azure App Configuration with Key Vault and Managed Identity in HA</h1><div class="post-meta">2020-04-30</div><div class="post-content"><p><a href="https://docs.microsoft.com/en-us/azure/azure-app-configuration/enable-dynamic-configuration-aspnet-core?tabs=core3x" target="_blank" rel="noopener">Here’s</a> what Azure App Configuration Service is.</p>
<p>And I want a production ready setup:</p>
<ul>
<li>use it to serve secret params as well, keeping them in Key Vault</li>
<li>access it with <a href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview" target="_blank" rel="noopener">Managed Identity</a>(MI).</li>
<li>have it in High Availability</li>
</ul>
<h3 id="How-Azure-App-Configuration-client-works"><a href="#How-Azure-App-Configuration-client-works" class="headerlink" title="How Azure App Configuration client works"></a>How Azure App Configuration client works</h3><p>Here’s how the client works, <strong>using the sentinel pattern</strong>, i.e., using one key to be the one that the client actually checks to know whether or not a full configuration refresh is needed.<br>When <em>Refresh</em> methods are called, the client:</p>
<ul>
<li>checks whether cache is expired. If it’s not, it does nothing and keeps using the values in cache</li>
<li>if cache is expired, client will go ahead and get ‘sentinel’ app configuration parameter.</li>
<li>if sentinel hasn’t changed from last time, it does nothing and keeps using the values in cache</li>
<li>if sentinel has changed, it will go and refresh all configuration parameters.</li>
<li>when making a request to the App Configuration service if it fails, then an attempt with the Fail over App Configuration configured is attempted. The <em>fail over</em> service is typically located in a different azure region.</li>
</ul>
<p>So, <strong>every time a parameter is changed in the configuration, sentinel must be changed as well so the client knows that it needs to do a full refresh</strong>.</p>
<h3 id="Configure-API-Key-Vault-and-App-Configuration-access-in-Azure"><a href="#Configure-API-Key-Vault-and-App-Configuration-access-in-Azure" class="headerlink" title="Configure API, Key Vault and App Configuration access in Azure"></a>Configure API, Key Vault and App Configuration access in Azure</h3><ul>
<li>Create an api app and <a href="https://docs.microsoft.com/en-us/azure/app-service/overview-managed-identity?tabs=dotnet" target="_blank" rel="noopener">add a Systems Managed Identity</a></li>
<li>Create a Key Vault and add a policy so the Api App identity can read secrets</li>
<li>Create an App Configuration. In <em>Access Control(IAM)</em> add the Api App identity with the role <em>App Configuration Data Reader</em>.</li>
</ul>
<p>It’s relevant that the App Configuration services <strong>does not keep key vault values or accesses key vault in any way</strong>. It just keeps the reference to the parameter, so what we’ll configure next is the application configuration provider to be able to go to the key vault and actually retrieve the parameter value, after the name is received from the App Configuration.</p>
<h3 id="Create-the-params-in-App-Configuration"><a href="#Create-the-params-in-App-Configuration" class="headerlink" title="Create the params in App Configuration"></a>Create the params in App Configuration</h3><p>I like to simulate a json structure, as one normally comes from appsettings.json. So I prefix with application name, and observe the format [ApplicationName]:[ParamName]<br>It’s also usefull when more than one application consume the App Configuration service.</p>
<p>The params in our case would be (let’s create various types/options):</p>
<ul>
<li><em>Bustroker.AzureAppConfiguration.WebApi:Sentinel</em> =&gt; 0</li>
<li><em>Bustroker.AzureAppConfiguration.WebApi:CsvValues</em> =&gt; Mr Orange,Mr Pink,Mr Brown</li>
<li><em>Bustroker.AzureAppConfiguration.WebApi:IntegerValue</em> =&gt; 69</li>
<li><em>Bustroker.AzureAppConfiguration.WebApi:SecretInKeyvault</em> =&gt; The value is kept in key vault. When creating it, just select “Key Vault Reference”, rather than “Key-value”.</li>
</ul>
<h3 id="Now-the-code"><a href="#Now-the-code" class="headerlink" title="Now the code"></a>Now the code</h3><h4 id="First-add-the-nuget-package"><a href="#First-add-the-nuget-package" class="headerlink" title="First, add the nuget package"></a>First, add the nuget package</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet add package Microsoft.Azure.AppConfiguration.AspNetCore</span><br></pre></td></tr></table></figure>

<h4 id="Then-it-goes-like-this"><a href="#Then-it-goes-like-this" class="headerlink" title="Then it goes like this."></a>Then it goes like this.</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Program.cs</span><br><span class="line">public static IHostBuilder CreateHostBuilder(string[] args) &#x3D;&gt;</span><br><span class="line">    Host.CreateDefaultBuilder(args)</span><br><span class="line">        .ConfigureWebHostDefaults(webBuilder &#x3D;&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            webBuilder</span><br><span class="line">                .ConfigureAppConfiguration((hostingContext, config) &#x3D;&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        var settings &#x3D; config.Build();</span><br><span class="line">                        var azAppConfigurationMainRegionUrl &#x3D; settings.GetValue&lt;string&gt;(&quot;AzAppConfigurationMainRegionUrl&quot;);</span><br><span class="line">                        var azAppConfigurationFailOverRegionUrl &#x3D; settings.GetValue&lt;string&gt;(&quot;AzAppConfigurationMainRegionUrl&quot;);</span><br><span class="line"></span><br><span class="line">                        config</span><br><span class="line">                            .AddAzureAppConfiguration(options &#x3D;&gt; </span><br><span class="line">                            &#123;</span><br><span class="line">                                options.Connect(new Uri(azAppConfigurationFailOverRegionUrl), new DefaultAzureCredential())</span><br><span class="line">                                    .ConfigureKeyVault(kv &#x3D;&gt; </span><br><span class="line">                                    &#123;</span><br><span class="line">                                        kv.SetCredential(new DefaultAzureCredential());</span><br><span class="line">                                    &#125;)</span><br><span class="line">                                    .ConfigureRefresh(refreshOptions &#x3D;&gt;</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        refreshOptions.Register(&quot;Bustroker.AzureAppConfiguration.WebApi:sentinel&quot;, refreshAll: true)</span><br><span class="line">                                                .SetCacheExpiration(TimeSpan.FromSeconds(30));</span><br><span class="line">                                    &#125;);</span><br><span class="line">                            &#125;, optional: true)</span><br><span class="line">                            .AddAzureAppConfiguration(options &#x3D;&gt; </span><br><span class="line">                            &#123;</span><br><span class="line">                                options.Connect(new Uri(azAppConfigurationMainRegionUrl), new DefaultAzureCredential())</span><br><span class="line">                                    .ConfigureKeyVault(kv &#x3D;&gt; </span><br><span class="line">                                    &#123;</span><br><span class="line">                                        kv.SetCredential(new DefaultAzureCredential());</span><br><span class="line">                                    &#125;)</span><br><span class="line">                                    .ConfigureRefresh(refreshOptions &#x3D;&gt;</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        refreshOptions.Register(&quot;Bustroker.AzureAppConfiguration.WebApi:sentinel&quot;, refreshAll: true)</span><br><span class="line">                                                .SetCacheExpiration(TimeSpan.FromSeconds(1));</span><br><span class="line">                                    &#125;);</span><br><span class="line">                            &#125;, optional: true);</span><br><span class="line">                    &#125;)</span><br><span class="line">                .UseStartup&lt;Startup&gt;();</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<p>Note the <em>ConfigureKeyVault(kv =&gt; ..)</em> method.</p>
<ul>
<li>AddAzureAppConfiguration(..): adds a configuration provider for <em>Az App Configuration</em> service to the API, i.e., a source to populate IConfiguration from <em>Az App Configuration</em>. Two are configured, one for failover (yes, the first one is the failover one ¿?… see <a href="https://docs.microsoft.com/en-us/azure/azure-app-configuration/concept-disaster-recovery?tabs=core3x" target="_blank" rel="noopener">here</a>), both optional. In case of no HA desired, only configure one, preferably with <em>optional: false</em>.</li>
<li>Connect(..): configure actual connection to az AppConfiguration, in this case with Managed Id</li>
<li>ConfigureKeyVault(..): configure keyvault so values in <em>Az App Configuration</em> that are in Key Vault can be accessed by the application</li>
<li>ConfigureRefresh(..): configure refresh of the cache of the App Configuration Client, as explained before.</li>
</ul>
<p>DefaultAzureCredential class is the one responsible for getting the credentials available through MI.<br><em>Note: for DefaultAzureCredential class to work locally, the credentials need to be provided in the local environment. See <a href="https://docs.microsoft.com/sv-se/dotnet/api/azure.identity.defaultazurecredential?view=azure-dotnet" target="_blank" rel="noopener">here</a></em></p>
<h3 id="Register-a-configuration-section-so-it’s-bound-against-TOptions-and-IAzureAppConfigurationRefresher-service"><a href="#Register-a-configuration-section-so-it’s-bound-against-TOptions-and-IAzureAppConfigurationRefresher-service" class="headerlink" title="Register a configuration section so it’s bound against TOptions, and IAzureAppConfigurationRefresher service"></a>Register a configuration section so it’s bound against TOptions, and IAzureAppConfigurationRefresher service</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Startup.ConfigureServices(...)</span><br><span class="line">services.Configure&lt;AppSettings&gt;(Configuration.GetSection(&quot;Bustroker.AzureAppConfiguration.WebApi&quot;));</span><br><span class="line">services.AddScoped&lt;IAzureAppConfigurationRefresher, OnDemandAzureAppConfigurationRefresher&gt;();</span><br></pre></td></tr></table></figure>

<h3 id="Using-Configuration-values"><a href="#Using-Configuration-values" class="headerlink" title="Using Configuration values"></a>Using Configuration values</h3><p>To use the configuration values, inject <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options?view=aspnetcore-3.1" target="_blank" rel="noopener">IOptionsSnapshot</a> into the Controller.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; AzAppConfigurationController.cs</span><br><span class="line">[ApiController]</span><br><span class="line">[Route(&quot;[controller]&quot;)]</span><br><span class="line">public class AzAppConfigurationController : ControllerBase</span><br><span class="line">&#123;</span><br><span class="line">    private readonly AppSettings _appSettings;</span><br><span class="line"></span><br><span class="line">    public AzAppConfigurationController(IOptionsSnapshot&lt;AppSettings&gt; appSettings)</span><br><span class="line">    &#123;</span><br><span class="line">        _appSettings &#x3D; appSettings.Value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [HttpGet]</span><br><span class="line">    public async Task&lt;IActionResult&gt; Get()</span><br><span class="line">    &#123;</span><br><span class="line">        await Task.CompletedTask;</span><br><span class="line">        return Ok(_appSettings);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>NOTE: it’s important to use IOptionsSnapshot, and not IOptions (wouldn’t refresh anyway unless restarted the application), nor IOptionsMonitor (could change the values in the middle of a request potentially leading to weird results).</strong> Check <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options?view=aspnetcore-3.1" target="_blank" rel="noopener">here</a>.</li>
</ul>
</div><div class="tags"><a href="/tags/azure-app-configuration/"><i class="fa fa-tag"></i>azure app configuration</a><a href="/tags/key-vault/"><i class="fa fa-tag"></i>key vault</a><a href="/tags/managed-identity/"><i class="fa fa-tag"></i>managed identity</a><a href="/tags/high-availability/"><i class="fa fa-tag"></i>high availability</a><a href="/tags/production-ready/"><i class="fa fa-tag"></i>production ready</a></div><div class="post-nav"><a class="pre" href="/handling-parallel-exceptions/">Handling parallel exceptions.</a><a class="next" href="/azure-api-app-failing-on-startup-with-500-30/">Azure Api App failing on startup with 500.30</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/simplest-node-express-web-api/">Simplest node express web API.</a></li><li class="post-list-item"><a class="post-list-link" href="/azure-app-configuration-refresh-on-demand/">Azure App Configuration refresh on demand.</a></li><li class="post-list-item"><a class="post-list-link" href="/handling-parallel-exceptions/">Handling parallel exceptions.</a></li><li class="post-list-item"><a class="post-list-link" href="/azure-app-configuration-with-key-vault-and-managed-identity-in-ha/">Azure App Configuration with Key Vault and Managed Identity in HA</a></li><li class="post-list-item"><a class="post-list-link" href="/azure-api-app-failing-on-startup-with-500-30/">Azure Api App failing on startup with 500.30</a></li><li class="post-list-item"><a class="post-list-link" href="/voice-commands-assistant-in-node/">Voice commands assistant in node.</a></li><li class="post-list-item"><a class="post-list-link" href="/mortgage-simulator-in-python/">Mortgage simulator in python.</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Bustroker's cheat sheet.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>