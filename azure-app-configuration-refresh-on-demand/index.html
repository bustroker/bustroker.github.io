<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Software development"><title>Azure App Configuration refresh on demand. | Bustroker's cheat sheet</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-174998608-2','auto');ga('send','pageview');
</script><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/2.0.4/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/2.1.4/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/2.1.4/toastr.min.css"><meta name="generator" content="Hexo 4.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Azure App Configuration refresh on demand.</h1><a id="logo" href="/.">Bustroker's cheat sheet</a><p class="description">Quick notes on coding.</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Azure App Configuration refresh on demand.</h1><div class="post-meta">2020-05-06</div><div class="post-content"><p><a href="(https://docs.microsoft.com/en-us/azure/azure-app-configuration/enable-dynamic-configuration-aspnet-core?tabs=core3x)">Here’s</a> what Azure App Configuration Service is.</p>
<p><a href="http://www.bustroker.com/azure-app-configuration-with-key-vault-and-managed-identity-in-ha/">Here’s</a> how to use it.</p>
<h3 id="How-the-web-api-middleware-uses-the-App-Configuration-Client"><a href="#How-the-web-api-middleware-uses-the-App-Configuration-Client" class="headerlink" title="How the web api middleware uses the App Configuration Client"></a>How the web api middleware uses the App Configuration Client</h3><p>As per oficial <a href="https://docs.microsoft.com/en-us/azure/azure-app-configuration/enable-dynamic-configuration-aspnet-core?tabs=core3x" target="_blank" rel="noopener">documentation</a>, refering to </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Startup.Configure(IApplicationBuilder app, IWebHostEnvironment env)</span><br><span class="line">app.UseAzureAppConfiguration();</span><br></pre></td></tr></table></figure>

<p><em>“The middleware uses the refresh configuration specified in the AddAzureAppConfiguration method in Program.cs to trigger a refresh for each request received by the ASP.NET Core web app. For each request, a refresh operation is triggered and the client library checks if the cached value for the registered configuration setting has expired. If it’s expired, it’s refreshed.”</em></p>
<p>It’s worth to note that the refresh doesn’t happen synchronously, but as fire &amp; forget (you can check so in the <a href="https://github.com/Azure/AppConfiguration-DotnetProvider/blob/master/src/Microsoft.Azure.AppConfiguration.AspNetCore/AzureAppConfigurationRefreshMiddleware.cs" target="_blank" rel="noopener">code of the middleware</a>), so it actually does not impact the incomming request’s response time. Rather the next request is the one that will see the change in the value. </p>
<h3 id="On-demand-configuration-refresh"><a href="#On-demand-configuration-refresh" class="headerlink" title="On demand configuration refresh"></a>On demand configuration refresh</h3><p>But it doesn’t make sense to have one request every 30 seconds to ask for something that changes only once in a long while (not to talk about infinite cahe and having to restart the application when changing it).</p>
<p>Plus it does impact in cost, because considering a cache of 30 sec (the default) and an with one request every 30 seconds, you get one request to the ‘sentinel’ key every 30 seconds to the App Config Service, PER SERVICE with this configurations. So, 10 services make over 200k calls a day, and that is actually the limit above which the service starts charging extra. Not good.</p>
<p>So, this is not the behaviour I want, because:</p>
<ul>
<li>either it makes A LOT of extra calls, if cache expiration is short (and it costs money)</li>
<li>or there is a LONG time to apply config changes, if fache expiration is long</li>
</ul>
<p>What I want is:</p>
<ul>
<li>Minimum calls to Config API, because I’m short in cash :P</li>
<li>Short cache expiration because I need the changes are applied ASAP</li>
</ul>
<p>So, I implement an OnDemandAzureAppConfigurationRefresher and then expose an endpoint to trigger the refresh on demand.</p>
<h3 id="Implementing-OnDemandAzureAppConfigurationRefresher"><a href="#Implementing-OnDemandAzureAppConfigurationRefresher" class="headerlink" title="Implementing OnDemandAzureAppConfigurationRefresher"></a>Implementing OnDemandAzureAppConfigurationRefresher</h3><p>I don’t want the refresh to be triggered by the middleware, instead I want to call it explicitly, so:</p>
<ul>
<li>I won’t register the AppConfiguration middleware in Startup.Configure</li>
<li>I’ll implement the refresh as it is done in AzureAppConfigurationRefreshMiddleware class, in <a href="https://github.com/Azure/AppConfiguration-DotnetProvider" target="_blank" rel="noopener">Microsoft’s repo</a>, like this</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public class OnDemandAzureAppConfigurationRefresher : IAzureAppConfigurationRefresher</span><br><span class="line">&#123;</span><br><span class="line">    private readonly List&lt;IConfigurationRefresher&gt; _configurationRefreshers &#x3D; new List&lt;IConfigurationRefresher&gt;();</span><br><span class="line"></span><br><span class="line">    public OnDemandAzureAppConfigurationRefresher(IConfiguration configuration)</span><br><span class="line">    &#123;</span><br><span class="line">        var configurationRoot &#x3D; configuration as IConfigurationRoot;</span><br><span class="line"></span><br><span class="line">        if (configurationRoot &#x3D;&#x3D; null)</span><br><span class="line">        &#123;</span><br><span class="line">            throw new InvalidOperationException(&quot;The &#39;IConfiguration&#39; injected in OnDemantConfigurationRefresher is not an &#39;IConfigurationRoot&#39;, and needs to be as well.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        foreach (var provider in configurationRoot.Providers)</span><br><span class="line">        &#123;</span><br><span class="line">            if (provider is IConfigurationRefresher refresher)</span><br><span class="line">            &#123;</span><br><span class="line">                _configurationRefreshers.Add(refresher);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public async Task RefreshAllRegisteredKeysAsync()</span><br><span class="line">    &#123;</span><br><span class="line">        Task compositeTask &#x3D; null;</span><br><span class="line">        var refreshersTasks &#x3D; new List&lt;Task&gt;();</span><br><span class="line">        try</span><br><span class="line">        &#123;</span><br><span class="line">            _configurationRefreshers.ForEach(r &#x3D;&gt; refreshersTasks.Add(r.RefreshAsync()));</span><br><span class="line">            compositeTask &#x3D; Task.WhenAll(refreshersTasks);</span><br><span class="line">            await compositeTask;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Exception)</span><br><span class="line">        &#123;</span><br><span class="line">            throw compositeTask.Exception;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Add-App-Configuration-configuration"><a href="#Add-App-Configuration-configuration" class="headerlink" title="Add App Configuration configuration"></a>Add App Configuration configuration</h3><p>First add the nuget package from the console</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet add package Microsoft.Azure.AppConfiguration.AspNetCore</span><br></pre></td></tr></table></figure>
<p>Add the App Configuration as the configuration to use, with a refreshing config (this is a basic config, to focus on the refresh part).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Program.cs</span><br><span class="line">public static IHostBuilder CreateHostBuilder(string[] args) &#x3D;&gt;</span><br><span class="line">    Host.CreateDefaultBuilder(args)</span><br><span class="line">        .ConfigureWebHostDefaults(webBuilder &#x3D;&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            webBuilder</span><br><span class="line">                .ConfigureAppConfiguration((hostingContext, config) &#x3D;&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        var settings &#x3D; config.Build();</span><br><span class="line"></span><br><span class="line">                        config</span><br><span class="line">                            .AddAzureAppConfiguration(options &#x3D;&gt; </span><br><span class="line">                            &#123;</span><br><span class="line">                                options.Connect(settings[&quot;ConnectionStrings:AzAppConfigurationConnectionString&quot;])</span><br><span class="line">                                    .ConfigureRefresh(refreshOptions &#x3D;&gt;</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        refreshOptions.Register(&quot;Bustroker.AppConfiguration.WebApi:sentinel&quot;, refreshAll: true)</span><br><span class="line">                                                .SetCacheExpiration(TimeSpan.FromSeconds(30));</span><br><span class="line">                                    &#125;);</span><br><span class="line">                            &#125;);</span><br><span class="line">                    &#125;)</span><br><span class="line">                .UseStartup&lt;Startup&gt;();</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<p>Register the service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Startup.ConfigureServices</span><br><span class="line">services.AddScoped&lt;IAzureAppConfigurationRefresher, OnDemandAzureAppConfigurationRefresher&gt;();</span><br></pre></td></tr></table></figure>

<h3 id="Expose-an-endpoint-to-trigger-App-Configuration-refresh-on-demand"><a href="#Expose-an-endpoint-to-trigger-App-Configuration-refresh-on-demand" class="headerlink" title="Expose an endpoint to trigger App Configuration refresh on demand"></a>Expose an endpoint to trigger App Configuration refresh on demand</h3><p>Inject it in a Refresh controller to expose the refresh endpoint</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; RefreshAzAppConfigurationController</span><br><span class="line"></span><br><span class="line">[ApiController]</span><br><span class="line">[Route(&quot;[controller]&quot;)]</span><br><span class="line">public class RefreshAzAppConfigurationController : ControllerBase</span><br><span class="line">&#123;</span><br><span class="line">    private readonly IAzureAppConfigurationRefresher _azureAppConfigurationRefresher;</span><br><span class="line"></span><br><span class="line">    public RefreshAzAppConfigurationController(IAzureAppConfigurationRefresher onDemandConfigurationRefresher)</span><br><span class="line">    &#123;</span><br><span class="line">        _azureAppConfigurationRefresher &#x3D; onDemandConfigurationRefresher;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [HttpPost]</span><br><span class="line">    public async Task&lt;IActionResult&gt; Post()</span><br><span class="line">    &#123;</span><br><span class="line">        await _azureAppConfigurationRefresher.RefreshAllRegisteredKeysAsync();</span><br><span class="line">        return Ok();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Talk-is-cheap"><a href="#Talk-is-cheap" class="headerlink" title="Talk is cheap"></a>Talk is cheap</h3><p><a href="https://github.com/bustroker/Bustroker.AzureAppConfiguration" target="_blank" rel="noopener">Here’s</a> the full code &amp; usage, and <a href="https://www.nuget.org/packages/Bustroker.AzureAppConfigurationRefresher/" target="_blank" rel="noopener">here’s</a> the nuget package with the refresher.</p>
</div><div class="tags"><a href="/tags/azure/"><i class="fa fa-tag"></i>azure</a></div><div class="post-nav"><a class="pre" href="/azure-api-app-failing-on-startup-with-500-30/">Azure Api App failing on startup with 500.30</a><a class="next" href="/handling-parallel-exceptions/">Handling parallel exceptions.</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/build-native-mobile-packages-from-html-css-js-app-with-phonegap-build-cloud-service/">Build native mobile packages from html/css/js app with PhoneGap Build cloud service.</a></li><li class="post-list-item"><a class="post-list-link" href="/setup-dotnet-core-app-with-vagrant-and-docker/">Setup dotnet core app with vagrant and docker.</a></li><li class="post-list-item"><a class="post-list-link" href="/deploy-dotnet-core-app-to-heroku/">Deploy dotnet core app to heroku.</a></li><li class="post-list-item"><a class="post-list-link" href="/kubernetes-commands-cheat-sheet/">Kubernetes commands cheat sheet.</a></li><li class="post-list-item"><a class="post-list-link" href="/docker-commands-cheat-sheet/">Docker commands cheat sheet.</a></li><li class="post-list-item"><a class="post-list-link" href="/net-core-3-1-appsettings-env-variables/">Net Core 3.1 appsettings & env variables</a></li><li class="post-list-item"><a class="post-list-link" href="/very-basic-logging-to-console-from-netcore-webapi/">Very basic logging to console from netcore webapi</a></li><li class="post-list-item"><a class="post-list-link" href="/very-basic-logging-to-file-from-console/">Very basic logging to file from Console</a></li><li class="post-list-item"><a class="post-list-link" href="/configure-a-rewrite-url-in-web-config-for-iis-hosted-apps/">Configure a rewrite url in web.config, for IIS hosted apps</a></li><li class="post-list-item"><a class="post-list-link" href="/net-core-3-1-ilogger-tcategory-with-azure-app-service-application-insights-plus-live-metrics/">Net Core 3.1 ILogger<TCategory> with azure app service Application Insights, plus Live Metrics</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/raspberry-pi/" style="font-size: 15px;">raspberry pi</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/dotnet-core/" style="font-size: 15px;">dotnet core</a> <a href="/tags/aspnet-core/" style="font-size: 15px;">aspnet core</a> <a href="/tags/azure/" style="font-size: 15px;">azure</a> <a href="/tags/node/" style="font-size: 15px;">node</a> <a href="/tags/command-line/" style="font-size: 15px;">command line</a> <a href="/tags/application-insights/" style="font-size: 15px;">application insights</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/cheatsheet/" style="font-size: 15px;">cheatsheet</a> <a href="/tags/vagrant/" style="font-size: 15px;">vagrant</a> <a href="/tags/k8s/" style="font-size: 15px;">k8s</a> <a href="/tags/heroku/" style="font-size: 15px;">heroku</a> <a href="/tags/kusto/" style="font-size: 15px;">kusto</a> <a href="/tags/nuget-config/" style="font-size: 15px;">nuget.config</a> <a href="/tags/phonegap/" style="font-size: 15px;">phonegap</a></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Bustroker's cheat sheet.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>