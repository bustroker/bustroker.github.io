<!doctype html>

<html lang="en" class="h-100">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="generator" content="Hugo 0.123.7">
  <link rel="stylesheet" href="https://www.bustroker.com/css/bootstrap.min.css">
  
  
  <title>.NET Templates and Database Migrations | Coding notes - cheat sheets and snippets</title>
  <style>
.container {
  max-width: 700px;
}
#nav a {
  font-weight: bold;
  color: inherit;
}
#nav a.nav-link-active {
  background-color: #212529;
  color: #fff;
}
#nav-border {
  border-bottom: 1px solid #212529;
}
#main {
  margin-top: 1em;
  margin-bottom: 4em;
}
#home-jumbotron {
  background-color: inherit;
}
#footer .container {
  padding: 1em 0;
}
#footer a {
  color: inherit;
  text-decoration: underline;
}
.font-125 {
  font-size: 125%;
}
.tag-btn {
  margin-bottom: 0.3em;
}
pre {
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  padding: 16px;
}
pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  background-color: transparent;
  border-radius: 0;
}
code {
  padding: 2px 4px;
  font-size: 90%;
  color: #c7254e;
  background-color: #f9f2f4;
  border-radius: 4px;
}
img,
iframe,
embed,
video,
audio {
  max-width: 100%;
}
.card-img,
.card-img-top,
.card-img-bottom {
  width: initial;
}
</style>
</head>
  <body class="d-flex flex-column h-100">
    <div id="nav-border" class="container">
  <nav id="nav" class="nav justify-content-center">
  
  
  
    
    
      
      
      
      
      
        
      
    
    
    <a class="nav-link " href="/"><i data-feather="home"></i> Home</a>
  
    
    
      
      
      
      
      
        
      
    
    
    <a class="nav-link " href="/notes/"><i data-feather="edit"></i> Notes</a>
  
    
    
      
      
      
      
      
        
      
    
    
    <a class="nav-link " href="/tags/"><i data-feather="tag"></i> Tags</a>
  
  </nav>
</div>

    <div class="container">
      <main id="main">
        

<h1>.NET Templates and Database Migrations</h1>
<h2 id="net-custom-templates">.NET Custom Templates</h2>
<h3 id="testing-locally">Testing Locally</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">## Clone and navigate to repository</span>
</span></span><span style="display:flex;"><span>cd templates/bkr.microservice
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Install template</span>
</span></span><span style="display:flex;"><span>dotnet new -i .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Create new service</span>
</span></span><span style="display:flex;"><span>mkdir MyService <span style="color:#f92672">&amp;&amp;</span> cd MyService
</span></span><span style="display:flex;"><span>dotnet new bkr.microservice --name Cheese.Cake
</span></span></code></pre></div><h3 id="distributing-via-package">Distributing via Package</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">## Create package</span>
</span></span><span style="display:flex;"><span>dotnet pack
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Install from package</span>
</span></span><span style="display:flex;"><span>dotnet new -i ./bin/Debug/Bkr.Template.Service.1.0.0.nupkg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Use template</span>
</span></span><span style="display:flex;"><span>mkdir MyService <span style="color:#f92672">&amp;&amp;</span> cd MyService
</span></span><span style="display:flex;"><span>dotnet new bkr.microservice --name Cheese.Cake
</span></span></code></pre></div><h3 id="template-structure">Template Structure</h3>
<p>When adding new projects, include them in both solutions:</p>
<ul>
<li><code>template.dotnet.service.sln</code> - for template development</li>
<li><code>templates/bkr.microservice/template/Vertical.Domain.sln</code> - template microservice</li>
</ul>
<h3 id="template-parameters">Template Parameters</h3>
<ul>
<li><code>name</code> - Domain name (e.g., <code>Evaluation.Scoring</code>). Used for namespaces, class names, file names, and k8s deployments.</li>
<li><code>skipRestore</code> - Skip NuGet package restoration after template creation.</li>
</ul>
<h4 id="name-transformations">Name Transformations</h4>
<ul>
<li><strong>As-is</strong>: Used for namespaces (<code>Evaluation.Scoring</code>)</li>
<li><strong>Alphanumeric</strong>: Used for class/file names (<code>EvaluationScoring</code>)</li>
<li><strong>Lowercase-hyphenated</strong>: Used for k8s deployments (<code>evaluation-scoring</code>)</li>
</ul>
<h3 id="template-configuration">Template Configuration</h3>
<p>Templating symbols are defined in <code>template.json</code>.</p>
<h4 id="http-port-generation">HTTP Port Generation</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#e6db74">&#34;httpsPort&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;generated&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;generator&#34;</span>: <span style="color:#e6db74">&#34;port&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;parameters&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;low&#34;</span>: <span style="color:#ae81ff">3000</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;high&#34;</span>: <span style="color:#ae81ff">6000</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;replaces&#34;</span>: <span style="color:#e6db74">&#34;5302&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="name-transformations-1">Name Transformations</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#e6db74">&#34;domainLower&#34;</span><span style="color:#960050;background-color:#1e0010">:</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;generated&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;generator&#34;</span>: <span style="color:#e6db74">&#34;casing&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;parameters&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;source&#34;</span>: <span style="color:#e6db74">&#34;name&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;toLower&#34;</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}<span style="color:#960050;background-color:#1e0010">,</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;domainAlphanumeric&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;generated&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;generator&#34;</span>: <span style="color:#e6db74">&#34;regex&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;dataType&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;replaces&#34;</span>: <span style="color:#e6db74">&#34;VerticalDomain&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;fileRename&#34;</span>: <span style="color:#e6db74">&#34;VerticalDomain&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;parameters&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;source&#34;</span>: <span style="color:#e6db74">&#34;name&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;steps&#34;</span>: [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;regex&#34;</span>: <span style="color:#e6db74">&#34;[^a-zA-Z\\d]&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;replacement&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}<span style="color:#960050;background-color:#1e0010">,</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;domainLowerHyphens&#34;</span><span style="color:#960050;background-color:#1e0010">:</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;generated&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;generator&#34;</span>: <span style="color:#e6db74">&#34;regex&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;dataType&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;replaces&#34;</span>: <span style="color:#e6db74">&#34;vertical-domain&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;parameters&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;source&#34;</span>: <span style="color:#e6db74">&#34;domainLower&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;steps&#34;</span>: [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;regex&#34;</span>: <span style="color:#e6db74">&#34;[^a-zA-Z\\d]&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;replacement&#34;</span>: <span style="color:#e6db74">&#34;-&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>    }    
</span></span><span style="display:flex;"><span>}<span style="color:#960050;background-color:#1e0010">,</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;domainLowerPath&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;generated&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;generator&#34;</span>: <span style="color:#e6db74">&#34;regex&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;dataType&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;replaces&#34;</span>: <span style="color:#e6db74">&#34;vertical/domain&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;parameters&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;source&#34;</span>: <span style="color:#e6db74">&#34;domainLower&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;steps&#34;</span>: [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;regex&#34;</span>: <span style="color:#e6db74">&#34;[^a-zA-Z\\d]&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;replacement&#34;</span>: <span style="color:#e6db74">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="database-migration-project">Database Migration Project</h2>
<h3 id="1-create-console-application">1. Create Console Application</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">## Create project</span>
</span></span><span style="display:flex;"><span>dotnet new console -n DatabaseMigrationTool
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Add NuGet packages</span>
</span></span><span style="display:flex;"><span>dotnet add package Ev.DbUpdate.KeyVault
</span></span><span style="display:flex;"><span>dotnet add package Microsoft.Extensions.Hosting
</span></span><span style="display:flex;"><span>dotnet add package Microsoft.Extensions.Hosting.Abstractions
</span></span></code></pre></div><h4 id="programcs">Program.cs</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Program</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> _fullNamespace = &lt;DbMigrationNameProject&gt;;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string?</span> _connectionString = <span style="color:#66d9ef">string</span>.Empty;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> Main(<span style="color:#66d9ef">string</span>[] args)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> returnCode;
</span></span><span style="display:flex;"><span>        Console.WriteLine(<span style="color:#e6db74">&#34;&lt;ServiceNameProject&gt; database migration host starting !!!&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">using</span> (<span style="color:#66d9ef">var</span> host = CreateHost(args))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            returnCode = host.StartWithResult();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Console.WriteLine(<span style="color:#e6db74">&#34;&lt;ServiceNameProject&gt; database migration host stopped !!!&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> returnCode;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> IHost CreateHost(<span style="color:#66d9ef">string</span>[] args)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> namespacePrefix = <span style="color:#66d9ef">typeof</span>(Program).Namespace;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> host = Host
</span></span><span style="display:flex;"><span>            .CreateDefaultBuilder(args)
</span></span><span style="display:flex;"><span>            .UseConsoleLifetime();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        host = host.UseDbUpdateWithKeyVaultConfigurationSourceAndArgs(
</span></span><span style="display:flex;"><span>            args,
</span></span><span style="display:flex;"><span>            ConfigureOptions()
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        .ConfigureServices((hostContext, _) =&gt;
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Extensions.TransformAzureSqlConnectionStringForClientSecretAuth(hostContext.Configuration);
</span></span><span style="display:flex;"><span>            _connectionString = hostContext.Configuration.GetConnectionString(<span style="color:#e6db74">&#34;SqlServer&#34;</span>);
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> host.Build();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> Action&lt;DbUpdateConfigurationBuilder&gt; ConfigureOptions()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> options =&gt; options
</span></span><span style="display:flex;"><span>                            .WithUpgradeScriptsInNamespace(<span style="color:#e6db74">$&#34;{_fullNamespace}.UpScripts&#34;</span>)
</span></span><span style="display:flex;"><span>                            .WithDowngradeScriptsInNamespace(<span style="color:#e6db74">$&#34;{_fullNamespace}.DownScripts&#34;</span>)
</span></span><span style="display:flex;"><span>                            .WithPreScripts(<span style="color:#e6db74">$&#34;{_fullNamespace}.PreScripts&#34;</span>)
</span></span><span style="display:flex;"><span>                            .WithPostScripts(<span style="color:#e6db74">$&#34;{_fullNamespace}.PostScripts&#34;</span>)
</span></span><span style="display:flex;"><span>                            .WithConnectionString(_connectionString);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="extensioncs">Extension.cs</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Extensions</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">char</span> _connectionStringPartsSeparator = <span style="color:#e6db74">&#39;;&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> AsConnectionStringWithKeysRemoved(<span style="color:#66d9ef">string</span> connectionString, <span style="color:#66d9ef">string</span>[] connStringKeysToRemove)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> connStringParts = connectionString.Split(_connectionStringPartsSeparator);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> builder = <span style="color:#66d9ef">new</span> StringBuilder();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> part <span style="color:#66d9ef">in</span> connStringParts.Where(_ =&gt; !<span style="color:#66d9ef">string</span>.IsNullOrEmpty(_)))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> partKeyValue = part.Split(<span style="color:#e6db74">&#39;=&#39;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> key = partKeyValue[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (connStringKeysToRemove.Any(_ =&gt; _.Equals(key)))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            builder.Append(part);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (part[^<span style="color:#ae81ff">1</span>] != _connectionStringPartsSeparator)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                builder.Append(_connectionStringPartsSeparator);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> builder.ToString();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> TransformAzureSqlConnectionStringForClientSecretAuth(<span style="color:#66d9ef">this</span> IConfiguration configuration)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> azureSqlConnectionString = configuration[<span style="color:#e6db74">&#34;ConnectionStrings:SqlServer&#34;</span>]!;
</span></span><span style="display:flex;"><span>        configuration[<span style="color:#e6db74">&#34;ConnectionStrings:SqlServer&#34;</span>] =
</span></span><span style="display:flex;"><span>            AsConnectionStringWithKeysRemoved(azureSqlConnectionString, <span style="color:#66d9ef">new</span>[] { <span style="color:#e6db74">&#34;Uid&#34;</span>, <span style="color:#e6db74">&#34;Authentication&#34;</span> });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="appsettingsjson">appsettings.json</h4>
<p>Connection string is retrieved from KeyVault automatically. No environment-specific files needed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;ConnectionStrings&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;SqlServer&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;Logging&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;LogLevel&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;Default&#34;</span>: <span style="color:#e6db74">&#34;Debug&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;System&#34;</span>: <span style="color:#e6db74">&#34;Information&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;Microsoft&#34;</span>: <span style="color:#e6db74">&#34;Information&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;DbUpdate&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;Timeout&#34;</span>: <span style="color:#e6db74">&#34;00:01:00.000&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;ConnectionStringName&#34;</span>: <span style="color:#e6db74">&#34;SqlServer&#34;</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;KeyVault&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;Enabled&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;Url&#34;</span>: <span style="color:#e6db74">&#34;https://#{keyVaultName}#.vault.azure.net/&#34;</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;DatabaseAadAccess&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;Enabled&#34;</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;AzureIdentity&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;Enabled&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;ClientId&#34;</span>: <span style="color:#e6db74">&#34;#{clientId}#&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;ClientSecret&#34;</span>: <span style="color:#e6db74">&#34;#{clientSecret}#&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;TenantId&#34;</span>: <span style="color:#e6db74">&#34;#{azAccountTenantId}#&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="2-create-migration-scripts">2. Create Migration Scripts</h3>
<p>Create <code>UpScripts</code> and <code>DownScripts</code> folders. Name format: <code>{YYYYMMDD}_{HHmmss}_MigrationName.sql</code></p>
<h4 id="upscript-example-20250626_120000_initialsetupsql">UpScript Example (20250626_120000_InitialSetup.sql)</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SET</span> XACT_ABORT <span style="color:#66d9ef">ON</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SET</span> NOCOUNT <span style="color:#66d9ef">ON</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">BEGIN</span> TRAN
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">BEGIN</span> TRY
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    PRINT <span style="color:#e6db74">&#39;Bootstrapping &lt;ServiceName&gt; schema...&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">IF</span> (SCHEMA_ID(<span style="color:#e6db74">&#39;&lt;SchemaName&gt;&#39;</span>) <span style="color:#66d9ef">IS</span> <span style="color:#66d9ef">NULL</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">BEGIN</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">EXEC</span> (<span style="color:#e6db74">&#39;CREATE SCHEMA [&lt;SchemaName&gt;] AUTHORIZATION [dbo]&#39;</span>)
</span></span><span style="display:flex;"><span>        PRINT <span style="color:#e6db74">&#39;Schema [&lt;SchemaName&gt;] - created.&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">END</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">ELSE</span>
</span></span><span style="display:flex;"><span>        PRINT <span style="color:#e6db74">&#39;Schema [&lt;SchemaName&gt;] - already in place.&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">COMMIT</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">END</span> TRY
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">BEGIN</span> CATCH
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">ROLLBACK</span>;
</span></span><span style="display:flex;"><span>    THROW;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">END</span> CATCH;
</span></span></code></pre></div><h4 id="downscript-example-20250626_120000_initialsetupsql">DownScript Example (20250626_120000_InitialSetup.sql)</h4>
<p>Up and Down scripts must have matching names for rollback support.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SET</span> XACT_ABORT <span style="color:#66d9ef">ON</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SET</span> NOCOUNT <span style="color:#66d9ef">ON</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">BEGIN</span> TRAN
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">BEGIN</span> TRY
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">IF</span> (SCHEMA_ID(<span style="color:#e6db74">&#39;&lt;SchemaName&gt;&#39;</span>) <span style="color:#66d9ef">IS</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">BEGIN</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">EXEC</span> (<span style="color:#e6db74">&#39;DROP SCHEMA [&lt;SchemaName&gt;]&#39;</span>)
</span></span><span style="display:flex;"><span>        PRINT <span style="color:#e6db74">&#39;Schema [&lt;SchemaName&gt;] - dropped.&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">END</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">COMMIT</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">END</span> TRY
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">BEGIN</span> CATCH
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">ROLLBACK</span>;
</span></span><span style="display:flex;"><span>    THROW;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">END</span> CATCH;
</span></span></code></pre></div><h4 id="project-file-configuration">Project File Configuration</h4>
<p>Add to <code>.csproj</code> to automatically include all scripts without manual entries:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;ItemGroup&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;None</span> <span style="color:#a6e22e">Remove=</span><span style="color:#e6db74">&#34;appsettings.json&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;None</span> <span style="color:#a6e22e">Remove=</span><span style="color:#e6db74">&#34;DownScripts\*&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;None</span> <span style="color:#a6e22e">Remove=</span><span style="color:#e6db74">&#34;UpScripts\*&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/ItemGroup&gt;</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;ItemGroup&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;Content</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;appsettings.json&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;CopyToOutputDirectory&gt;</span>PreserveNewest<span style="color:#f92672">&lt;/CopyToOutputDirectory&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;ExcludeFromSingleFile&gt;</span>true<span style="color:#f92672">&lt;/ExcludeFromSingleFile&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;CopyToPublishDirectory&gt;</span>PreserveNewest<span style="color:#f92672">&lt;/CopyToPublishDirectory&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/Content&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/ItemGroup&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;ItemGroup&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;EmbeddedResource</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;DownScripts\*&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;CopyToOutputDirectory&gt;</span>Never<span style="color:#f92672">&lt;/CopyToOutputDirectory&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/EmbeddedResource&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;EmbeddedResource</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;UpScripts\*&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;CopyToOutputDirectory&gt;</span>Never<span style="color:#f92672">&lt;/CopyToOutputDirectory&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/EmbeddedResource&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/ItemGroup&gt;</span>
</span></span></code></pre></div><h3 id="3-pipeline-configuration">3. Pipeline Configuration</h3>
<h4 id="packageyml">package.yml</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#f92672">variables</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">databaseMigrationCsprojName</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#39;&lt;DatabaseMigrationProjectName&gt;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">jobs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">template</span>: <span style="color:#ae81ff">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">parameters</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">publishDatabaseMigration</span>: <span style="color:#e6db74">&#39;true&#39;</span>
</span></span></code></pre></div><h4 id="pullrequestyml">pullrequest.yml</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#f92672">variables</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">databaseProjectLocation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#ae81ff">&lt;DatabaseMigrationProjectName&gt;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">databaseMigrationCsprojName</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#ae81ff">&lt;DatabaseMigrationProjectName&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">jobs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">template</span>: <span style="color:#ae81ff">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">parameters</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">runDatabaseMigration</span>: <span style="color:#e6db74">&#39;true&#39;</span>
</span></span></code></pre></div><h4 id="azure-devops-variable-groups">Azure DevOps Variable Groups</h4>
<p>Add to both Lab and Prd variable groups (<code>Lab-&lt;Vertical&gt;&lt;Service&gt;-Common</code>, <code>Prd-&lt;Vertical&gt;&lt;Service&gt;-Common</code>):</p>
<ul>
<li><code>databaseMigrationCsprojName</code> = <code>&lt;DatabaseMigrationProjectName&gt;</code></li>
<li><code>publishDatabaseMigration</code> = <code>true</code></li>
</ul>
<h4 id="infrastructure">Infrastructure</h4>
<p>Uncomment the database section in <code>infrastructure.bicep</code> to create the Azure SQL database.</p>



      </main>
    </div>
    
<footer id="footer" class="mt-auto text-center text-muted">
  <div class="container">
    Bustroker - Made with <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/zwbetz-gh/vanilla-bootstrap-hugo-theme">Vanilla</a>
  </div>
</footer>

    <script src="https://www.bustroker.com/js/feather.min.js"></script>
<script>
  feather.replace()
</script>


    


<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css"
  integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq"
  crossorigin="anonymous"
/>


<script
  defer
  src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"
  integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz"
  crossorigin="anonymous"
></script>


<script
  defer
  src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js"
  integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI"
  crossorigin="anonymous"
  onload="renderMathInElement(document.body);"
></script>


    
  

  </body>
</html>